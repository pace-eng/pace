# L2-STATE-001: ä»»åŠ¡çŠ¶æ€ç®¡ç†é›†æˆ

## ä»»åŠ¡æ ‡è¯†
- **ä»»åŠ¡ID**: L2-STATE-001
- **ä»»åŠ¡ç±»å‹**: Level 2 - é›†æˆåè°ƒ
- **ä¼˜å…ˆçº§**: P0
- **é¢„ä¼°å·¥ä½œé‡**: 6å°æ—¶
- **è´Ÿè´£äºº**: å…¨æ ˆå¼€å‘
- **åˆ›å»ºæ—¥æœŸ**: 2024-01-11
- **æˆªæ­¢æ—¥æœŸ**: 2024-01-11

## ä¸šåŠ¡ä¸Šä¸‹æ–‡

### ä¸šåŠ¡ç›®æ ‡
å»ºç«‹å®Œæ•´çš„ä»»åŠ¡çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼Œå®ç°å‰ç«¯çŠ¶æ€ç®¡ç†ä¸åç«¯APIçš„æ— ç¼é›†æˆï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§å’Œå®æ—¶æ€§ã€‚

### ç”¨æˆ·ä»·å€¼
ç”¨æˆ·çš„ä»»åŠ¡æ“ä½œï¼ˆåˆ›å»ºã€æ›´æ–°ã€åˆ é™¤ï¼‰èƒ½å¤Ÿå®æ—¶åæ˜ åœ¨ç•Œé¢ä¸Šï¼Œæ•°æ®æŒä¹…åŒ–å­˜å‚¨ï¼Œå¤šé¡µé¢é—´çŠ¶æ€åŒæ­¥ï¼Œæä¾›æµç•…çš„ç”¨æˆ·ä½“éªŒã€‚

### ä¸šåŠ¡è§„åˆ™
- æ‰€æœ‰ä»»åŠ¡æ“ä½œå¿…é¡»åŒæ—¶æ›´æ–°å‰ç«¯çŠ¶æ€å’Œåç«¯æ•°æ®
- ç½‘ç»œé”™è¯¯æ—¶æä¾›å‹å¥½çš„é”™è¯¯æç¤ºå’Œé‡è¯•æœºåˆ¶
- æ”¯æŒä¹è§‚æ›´æ–°ï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- çŠ¶æ€å˜æ›´éœ€è¦æœ‰åŠ è½½æŒ‡ç¤ºå’ŒæˆåŠŸåé¦ˆ
- æ”¯æŒç¦»çº¿æ“ä½œçš„åŸºç¡€æ¶æ„

### éªŒæ”¶æ ‡å‡†
- [ ] ä»»åŠ¡CRUDæ“ä½œå‰åç«¯çŠ¶æ€å®Œå…¨åŒæ­¥
- [ ] ç½‘ç»œé”™è¯¯æ—¶æœ‰åˆé€‚çš„é”™è¯¯å¤„ç†å’Œç”¨æˆ·æç¤º
- [ ] ä¹è§‚æ›´æ–°æœºåˆ¶å·¥ä½œæ­£å¸¸ï¼Œå¤±è´¥æ—¶èƒ½æ­£ç¡®å›æ»š
- [ ] åŠ è½½çŠ¶æ€å’ŒæˆåŠŸæç¤ºç”¨æˆ·ä½“éªŒè‰¯å¥½
- [ ] çŠ¶æ€ç®¡ç†æ€§èƒ½ä¼˜ç§€ï¼Œæ— ä¸å¿…è¦çš„é‡æ¸²æŸ“
- [ ] å¤šç»„ä»¶é—´çŠ¶æ€å…±äº«æ­£å¸¸å·¥ä½œ
- [ ] æ•°æ®ç¼“å­˜ç­–ç•¥æœ‰æ•ˆï¼Œå‡å°‘ä¸å¿…è¦çš„APIè°ƒç”¨

## æŠ€æœ¯è§„æ ¼

### åŠŸèƒ½æè¿°
å®ç°åŸºäºZustandçš„çŠ¶æ€ç®¡ç†ç³»ç»Ÿï¼Œé›†æˆReact Queryè¿›è¡ŒæœåŠ¡ç«¯çŠ¶æ€ç®¡ç†ï¼Œå»ºç«‹å‰åç«¯æ•°æ®æµçš„å®Œæ•´é“¾è·¯ã€‚

### æŠ€æœ¯è¦æ±‚

| ç±»åˆ« | æè¿° | å¿…éœ€ |
|------|------|------|
| çŠ¶æ€ç®¡ç† | Zustand + React Query | âœ… |
| APIå®¢æˆ·ç«¯ | Axios + æ‹¦æˆªå™¨ | âœ… |
| é”™è¯¯å¤„ç† | ç»Ÿä¸€é”™è¯¯å¤„ç†æœºåˆ¶ | âœ… |
| ç¼“å­˜ç­–ç•¥ | React Queryç¼“å­˜é…ç½® | âœ… |
| ç±»å‹å®‰å…¨ | TypeScriptç±»å‹å®šä¹‰ | âœ… |

### æ¥å£å®šä¹‰

#### çŠ¶æ€ç®¡ç†Store
```typescript
interface TaskStore {
  // çŠ¶æ€
  tasks: Task[];
  selectedTask: Task | null;
  filters: TaskFilters;
  pagination: PaginationState;
  
  // UIçŠ¶æ€
  loading: boolean;
  error: string | null;
  
  // æ“ä½œæ–¹æ³•
  setTasks: (tasks: Task[]) => void;
  addTask: (task: Task) => void;
  updateTask: (id: number, updates: Partial<Task>) => void;
  removeTask: (id: number) => void;
  setSelectedTask: (task: Task | null) => void;
  setFilters: (filters: Partial<TaskFilters>) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
  
  // å¼‚æ­¥æ“ä½œ
  fetchTasks: () => Promise<void>;
  createTask: (data: CreateTaskRequest) => Promise<Task>;
  updateTaskAsync: (id: number, updates: UpdateTaskRequest) => Promise<Task>;
  deleteTask: (id: number) => Promise<void>;
}
```

#### APIæœåŠ¡æ¥å£
```typescript
interface TaskService {
  getTasks(filters?: TaskFilters): Promise<{ data: Task[]; total: number }>;
  getTask(id: number): Promise<Task>;
  createTask(data: CreateTaskRequest): Promise<Task>;
  updateTask(id: number, data: UpdateTaskRequest): Promise<Task>;
  deleteTask(id: number): Promise<void>;
}
```

#### React Queryé›†æˆ
```typescript
interface TaskQueries {
  useTasks: (filters?: TaskFilters) => UseQueryResult<Task[]>;
  useTask: (id: number) => UseQueryResult<Task>;
  useCreateTask: () => UseMutationResult<Task, Error, CreateTaskRequest>;
  useUpdateTask: () => UseMutationResult<Task, Error, { id: number; data: UpdateTaskRequest }>;
  useDeleteTask: () => UseMutationResult<void, Error, number>;
}
```

### æ•°æ®æµè®¾è®¡
```mermaid
graph TD
    A[ç”¨æˆ·æ“ä½œ] --> B[ç»„ä»¶äº‹ä»¶]
    B --> C[Zustand Store Action]
    C --> D[ä¹è§‚æ›´æ–° UI]
    C --> E[React Query Mutation]
    E --> F[APIè°ƒç”¨]
    F --> G{è¯·æ±‚æˆåŠŸ?}
    G -->|æˆåŠŸ| H[æ›´æ–°ç¼“å­˜]
    G -->|å¤±è´¥| I[å›æ»šçŠ¶æ€]
    H --> J[é€šçŸ¥ç»„ä»¶æ›´æ–°]
    I --> K[æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯]
```

## å®ç°æŒ‡å¯¼

### æ ¸å¿ƒå®ç°

#### 1. Zustand Storeå®ç°
```typescript
import { create } from 'zustand';
import { devtools, subscribeWithSelector } from 'zustand/middleware';
import { immer } from 'zustand/middleware/immer';

interface TaskStore {
  // State
  tasks: Task[];
  selectedTask: Task | null;
  filters: TaskFilters;
  loading: boolean;
  error: string | null;
  
  // Actions
  setTasks: (tasks: Task[]) => void;
  addTask: (task: Task) => void;
  updateTask: (id: number, updates: Partial<Task>) => void;
  removeTask: (id: number) => void;
  setSelectedTask: (task: Task | null) => void;
  setFilters: (filters: Partial<TaskFilters>) => void;
  setLoading: (loading: boolean) => void;
  setError: (error: string | null) => void;
}

export const useTaskStore = create<TaskStore>()(
  devtools(
    subscribeWithSelector(
      immer((set, get) => ({
        // Initial state
        tasks: [],
        selectedTask: null,
        filters: {
          status: undefined,
          priority: undefined,
          search: '',
        },
        loading: false,
        error: null,
        
        // Actions
        setTasks: (tasks) => {
          set((state) => {
            state.tasks = tasks;
            state.error = null;
          });
        },
        
        addTask: (task) => {
          set((state) => {
            state.tasks.unshift(task);
          });
        },
        
        updateTask: (id, updates) => {
          set((state) => {
            const index = state.tasks.findIndex(task => task.id === id);
            if (index !== -1) {
              Object.assign(state.tasks[index], updates);
            }
          });
        },
        
        removeTask: (id) => {
          set((state) => {
            state.tasks = state.tasks.filter(task => task.id !== id);
            if (state.selectedTask?.id === id) {
              state.selectedTask = null;
            }
          });
        },
        
        setSelectedTask: (task) => {
          set((state) => {
            state.selectedTask = task;
          });
        },
        
        setFilters: (filters) => {
          set((state) => {
            Object.assign(state.filters, filters);
          });
        },
        
        setLoading: (loading) => {
          set((state) => {
            state.loading = loading;
          });
        },
        
        setError: (error) => {
          set((state) => {
            state.error = error;
          });
        },
      }))
    ),
    { name: 'task-store' }
  )
);
```

#### 2. APIæœåŠ¡å±‚
```typescript
import axios from 'axios';

const api = axios.create({
  baseURL: '/api/v1',
  timeout: 10000,
});

// è¯·æ±‚æ‹¦æˆªå™¨
api.interceptors.request.use(
  (config) => {
    // æ·»åŠ è®¤è¯tokenç­‰
    return config;
  },
  (error) => Promise.reject(error)
);

// å“åº”æ‹¦æˆªå™¨
api.interceptors.response.use(
  (response) => response.data,
  (error) => {
    const message = error.response?.data?.message || 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
    return Promise.reject(new Error(message));
  }
);

export const taskService = {
  async getTasks(filters?: TaskFilters) {
    const params = new URLSearchParams();
    if (filters?.status) params.append('status', filters.status);
    if (filters?.priority) params.append('priority', filters.priority);
    if (filters?.search) params.append('search', filters.search);
    
    return api.get(`/tasks?${params}`);
  },
  
  async getTask(id: number) {
    return api.get(`/tasks/${id}`);
  },
  
  async createTask(data: CreateTaskRequest) {
    return api.post('/tasks', data);
  },
  
  async updateTask(id: number, data: UpdateTaskRequest) {
    return api.put(`/tasks/${id}`, data);
  },
  
  async deleteTask(id: number) {
    return api.delete(`/tasks/${id}`);
  },
};
```

#### 3. React Queryé›†æˆ
```typescript
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { taskService } from './taskService';
import { useTaskStore } from './taskStore';

export const taskQueryKeys = {
  all: ['tasks'] as const,
  lists: () => [...taskQueryKeys.all, 'list'] as const,
  list: (filters: TaskFilters) => [...taskQueryKeys.lists(), filters] as const,
  details: () => [...taskQueryKeys.all, 'detail'] as const,
  detail: (id: number) => [...taskQueryKeys.details(), id] as const,
};

export function useTasks(filters?: TaskFilters) {
  return useQuery({
    queryKey: taskQueryKeys.list(filters || {}),
    queryFn: () => taskService.getTasks(filters),
    staleTime: 5 * 60 * 1000, // 5åˆ†é’Ÿ
    cacheTime: 10 * 60 * 1000, // 10åˆ†é’Ÿ
  });
}

export function useCreateTask() {
  const queryClient = useQueryClient();
  const { addTask, setError } = useTaskStore();
  
  return useMutation({
    mutationFn: taskService.createTask,
    onMutate: async (newTask) => {
      // ä¹è§‚æ›´æ–°
      const optimisticTask = {
        id: Date.now(), // ä¸´æ—¶ID
        ...newTask,
        status: 'todo' as const,
        createdAt: new Date(),
        updatedAt: new Date(),
      };
      
      addTask(optimisticTask);
      return { optimisticTask };
    },
    onSuccess: (data, variables, context) => {
      // æ›¿æ¢ä¸´æ—¶ä»»åŠ¡
      const { updateTask, removeTask } = useTaskStore.getState();
      removeTask(context?.optimisticTask.id!);
      addTask(data);
      
      // ä½¿ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: taskQueryKeys.lists() });
    },
    onError: (error, variables, context) => {
      // å›æ»šä¹è§‚æ›´æ–°
      if (context?.optimisticTask) {
        const { removeTask } = useTaskStore.getState();
        removeTask(context.optimisticTask.id);
      }
      
      setError(error.message);
    },
  });
}

export function useUpdateTask() {
  const queryClient = useQueryClient();
  const { updateTask, setError } = useTaskStore();
  
  return useMutation({
    mutationFn: ({ id, data }: { id: number; data: UpdateTaskRequest }) =>
      taskService.updateTask(id, data),
    onMutate: async ({ id, data }) => {
      // ä¿å­˜å½“å‰çŠ¶æ€ç”¨äºå›æ»š
      const { tasks } = useTaskStore.getState();
      const currentTask = tasks.find(task => task.id === id);
      
      // ä¹è§‚æ›´æ–°
      updateTask(id, data);
      
      return { currentTask };
    },
    onSuccess: (data, { id }) => {
      // æ›´æ–°ä¸ºæœåŠ¡å™¨è¿”å›çš„æ•°æ®
      updateTask(id, data);
      
      // ä½¿ç¼“å­˜å¤±æ•ˆ
      queryClient.invalidateQueries({ queryKey: taskQueryKeys.detail(id) });
      queryClient.invalidateQueries({ queryKey: taskQueryKeys.lists() });
    },
    onError: (error, { id }, context) => {
      // å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€
      if (context?.currentTask) {
        updateTask(id, context.currentTask);
      }
      
      setError(error.message);
    },
  });
}
```

#### 4. è‡ªå®šä¹‰Hooké›†æˆ
```typescript
export function useTaskOperations() {
  const createMutation = useCreateTask();
  const updateMutation = useUpdateTask();
  const deleteMutation = useDeleteTask();
  
  const createTask = useCallback(async (data: CreateTaskRequest) => {
    try {
      await createMutation.mutateAsync(data);
      toast.success('ä»»åŠ¡åˆ›å»ºæˆåŠŸ');
    } catch (error) {
      toast.error('åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }, [createMutation]);
  
  const updateTask = useCallback(async (id: number, data: UpdateTaskRequest) => {
    try {
      await updateMutation.mutateAsync({ id, data });
      toast.success('ä»»åŠ¡æ›´æ–°æˆåŠŸ');
    } catch (error) {
      toast.error('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }, [updateMutation]);
  
  const deleteTask = useCallback(async (id: number) => {
    try {
      await deleteMutation.mutateAsync(id);
      toast.success('ä»»åŠ¡åˆ é™¤æˆåŠŸ');
    } catch (error) {
      toast.error('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }, [deleteMutation]);
  
  return {
    createTask,
    updateTask,
    deleteTask,
    isLoading: createMutation.isPending || updateMutation.isPending || deleteMutation.isPending,
  };
}
```

### æœ€ä½³å®è·µ
- ä½¿ç”¨ä¹è§‚æ›´æ–°æå‡ç”¨æˆ·ä½“éªŒ
- å®ç°å®Œå–„çš„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶
- åˆç†è®¾ç½®ç¼“å­˜ç­–ç•¥å‡å°‘APIè°ƒç”¨
- ä½¿ç”¨TypeScriptç¡®ä¿ç±»å‹å®‰å…¨
- åˆ†ç¦»ä¸šåŠ¡é€»è¾‘å’ŒUIçŠ¶æ€
- å®ç°ç»Ÿä¸€çš„åŠ è½½çŠ¶æ€ç®¡ç†

## ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | æè¿° | æ“ä½œ |
|----------|------|------|
| `src/stores/taskStore.ts` | Zustandä»»åŠ¡çŠ¶æ€ç®¡ç† | ğŸ“ create |
| `src/services/taskService.ts` | APIæœåŠ¡å±‚ | ğŸ“ create |
| `src/hooks/useTasks.ts` | React Queryé›†æˆHook | ğŸ“ create |
| `src/hooks/useTaskOperations.ts` | ä»»åŠ¡æ“ä½œHook | ğŸ“ create |
| `src/types/api.ts` | APIç±»å‹å®šä¹‰ | ğŸ“ create |
| `src/utils/apiClient.ts` | Axiosé…ç½® | ğŸ“ create |
| `src/providers/QueryProvider.tsx` | React Query Provider | ğŸ“ create |

## è´¨é‡ä¿éšœ

### æµ‹è¯•ç­–ç•¥
- å•å…ƒæµ‹è¯•è¦†ç›–Store actionså’ŒAPI service
- é›†æˆæµ‹è¯•éªŒè¯å‰åç«¯æ•°æ®æµ
- Mock APIæµ‹è¯•ç½‘ç»œé”™è¯¯åœºæ™¯
- æ€§èƒ½æµ‹è¯•ç¡®ä¿çŠ¶æ€æ›´æ–°æ•ˆç‡

### éªŒè¯æ¸…å•
- [ ] æ‰€æœ‰CRUDæ“ä½œçŠ¶æ€åŒæ­¥æ­£ç¡®
- [ ] ä¹è§‚æ›´æ–°å’Œé”™è¯¯å›æ»šæ­£å¸¸å·¥ä½œ
- [ ] ç½‘ç»œé”™è¯¯å¤„ç†ç”¨æˆ·ä½“éªŒè‰¯å¥½
- [ ] ç¼“å­˜ç­–ç•¥æœ‰æ•ˆå‡å°‘APIè°ƒç”¨
- [ ] åŠ è½½çŠ¶æ€å’ŒæˆåŠŸæç¤ºåŠæ—¶å‡†ç¡®
- [ ] å¤šç»„ä»¶çŠ¶æ€å…±äº«æ— å†²çª
- [ ] å†…å­˜æ³„æ¼æ£€æŸ¥é€šè¿‡
- [ ] æ€§èƒ½åˆ†ææ— ä¸å¿…è¦é‡æ¸²æŸ“
- [ ] TypeScriptç±»å‹æ£€æŸ¥é€šè¿‡
- [ ] å•å…ƒæµ‹è¯•è¦†ç›–ç‡>85%

### é£é™©è¯„ä¼°
| é£é™©æè¿° | å½±å“ç¨‹åº¦ | å‘ç”Ÿæ¦‚ç‡ | ç¼“è§£æªæ–½ |
|----------|----------|----------|----------|
| çŠ¶æ€ç®¡ç†å¤æ‚åº¦è¿‡é«˜ | ğŸ”´ high | ğŸŸ¡ medium | ç®€åŒ–çŠ¶æ€ç»“æ„ï¼Œå……åˆ†æµ‹è¯• |
| ç½‘ç»œé”™è¯¯å½±å“ç”¨æˆ·ä½“éªŒ | ğŸŸ¡ medium | ğŸ”´ high | å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé‡è¯•æœºåˆ¶ |
| ä¹è§‚æ›´æ–°å¤±è´¥å¤„ç†ä¸å½“ | ğŸŸ¡ medium | ğŸŸ¡ medium | è¯¦ç»†çš„å›æ»šé€»è¾‘å’Œæµ‹è¯• |
| ç¼“å­˜ç­–ç•¥ä¸å½“å½±å“æ•°æ®ä¸€è‡´æ€§ | ğŸ”´ high | ğŸŸ¢ low | åˆç†çš„ç¼“å­˜æ—¶é—´å’Œå¤±æ•ˆç­–ç•¥ |

### å›æ»šè®¡åˆ’
å¦‚æœçŠ¶æ€ç®¡ç†é›†æˆå‡ºç°é—®é¢˜ï¼š
1. å›æ»šåˆ°ç®€å•çš„useStateæœ¬åœ°çŠ¶æ€ç®¡ç†
2. ä¸´æ—¶ç¦ç”¨ä¹è§‚æ›´æ–°ï¼Œä½¿ç”¨åŒæ­¥æ“ä½œ
3. ä½¿ç”¨æœ€åŸºæœ¬çš„APIè°ƒç”¨ï¼Œä¸ä½¿ç”¨ç¼“å­˜

---

## AIåä½œè¯´æ˜

è¿™æ˜¯ä¸€ä¸ªå…¸å‹çš„Level 2ä»»åŠ¡ï¼Œéœ€è¦äººæœºåä½œï¼š

### äººç±»è´Ÿè´£
- æ•´ä½“æ¶æ„è®¾è®¡å’ŒæŠ€æœ¯é€‰å‹
- æ•°æ®æµè®¾è®¡å’ŒçŠ¶æ€ç®¡ç†ç­–ç•¥
- é”™è¯¯å¤„ç†å’Œè¾¹ç•Œæƒ…å†µåˆ†æ
- æ€§èƒ½ä¼˜åŒ–å’Œç¼“å­˜ç­–ç•¥
- é›†æˆæµ‹è¯•å’Œè´¨é‡ä¿è¯

### AIè´Ÿè´£
- å…·ä½“çš„ä»£ç å®ç°
- ç±»å‹å®šä¹‰å’Œæ¥å£å®ç°
- å•å…ƒæµ‹è¯•ç¼–å†™
- ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£

### åä½œè¦ç‚¹
1. äººç±»å…ˆè®¾è®¡æ•´ä½“æ¶æ„å’Œæ•°æ®æµ
2. AIæ ¹æ®è®¾è®¡å®ç°å…·ä½“ä»£ç 
3. äººç±»reviewä»£ç å¹¶æå‡ºä¼˜åŒ–å»ºè®®
4. å…±åŒè°ƒè¯•å’Œè§£å†³é›†æˆé—®é¢˜
5. äººç±»è´Ÿè´£æœ€ç»ˆçš„è´¨é‡éªŒæ”¶

### æ³¨æ„äº‹é¡¹
- é‡ç‚¹å…³æ³¨çŠ¶æ€ä¸€è‡´æ€§å’Œæ•°æ®æµæ­£ç¡®æ€§
- ç¡®ä¿é”™è¯¯å¤„ç†è¦†ç›–æ‰€æœ‰å¼‚å¸¸æƒ…å†µ
- éªŒè¯ä¹è§‚æ›´æ–°çš„å›æ»šæœºåˆ¶
- æµ‹è¯•ç½‘ç»œå¼‚å¸¸æƒ…å†µä¸‹çš„ç”¨æˆ·ä½“éªŒ